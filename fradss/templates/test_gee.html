<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test GEE Interface</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: #333;
            color: white;
            padding: 20px;
        }
        
        .map-container {
            flex: 1;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
        }
        
        select, button {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        
        #status {
            background: #444;
            padding: 10px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>Test Controls</h3>
            
            <div class="control-group">
                <label>State:</label>
                <select id="stateSelect">
                    <option value="telangana">Telangana</option>
                    <option value="odisha">Odisha</option>
                    <option value="madhya pradesh">Madhya Pradesh</option>
                    <option value="tripura">Tripura</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>District:</label>
                <select id="districtSelect">
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="loadBoundaries">Load Boundaries</button>
                <button id="loadLanduse">Load Land-use Data</button>
                <button id="testAPI">Test API</button>
            </div>
            
            <div id="status">
                Ready...
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let map;
        let currentState = 'telangana';
        let boundariesLayer;
        let landuseLayer;
        
        function log(message) {
            const status = document.getElementById('status');
            status.innerHTML = message + '<br>' + status.innerHTML;
            console.log(message);
        }
        
        // Initialize map
        function initMap() {
            log('Initializing map...');
            map = L.map('map').setView([17.9689, 78.9629], 7);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            log('Map initialized successfully');
        }
        
        // Load districts
        async function loadDistricts(state) {
            log(`Loading districts for ${state}...`);
            try {
                const response = await fetch(`/api/districts/${state}`);
                const data = await response.json();
                log(`Districts loaded: ${data.districts ? data.districts.length : 0} districts`);
                
                const select = document.getElementById('districtSelect');
                select.innerHTML = '<option value="">All Districts</option>';
                
                if (data.districts) {
                    data.districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        select.appendChild(option);
                    });
                }
                
                return data;
            } catch (error) {
                log(`Error loading districts: ${error.message}`);
                return null;
            }
        }
        
        // Load boundaries
        async function loadBoundaries(state) {
            log(`Loading boundaries for ${state}...`);
            try {
                const response = await fetch(`/api/boundaries/${state}`);
                const data = await response.json();
                
                if (data.error) {
                    log(`Boundary error: ${data.error}`);
                    return;
                }
                
                // Remove existing boundaries
                if (boundariesLayer) {
                    map.removeLayer(boundariesLayer);
                }
                
                if (data.districts) {
                    log(`Adding ${data.districts.features.length} district boundaries`);
                    boundariesLayer = L.geoJSON(data.districts, {
                        style: {
                            fillColor: 'transparent',
                            weight: 2,
                            opacity: 0.8,
                            color: '#ff00ff',
                            fillOpacity: 0
                        }
                    }).addTo(map);
                    
                    map.fitBounds(boundariesLayer.getBounds());
                    log('Boundaries added successfully');
                } else {
                    log('No district data in response');
                }
                
            } catch (error) {
                log(`Error loading boundaries: ${error.message}`);
            }
        }
        
        // Load land-use data
        async function loadLanduse(state) {
            log(`Loading land-use data for ${state}...`);
            try {
                const response = await fetch(`/api/landuse_data/${state}`);
                const data = await response.json();
                
                if (data.error) {
                    log(`Land-use error: ${data.error}`);
                    return;
                }
                
                // Remove existing land-use layer
                if (landuseLayer) {
                    map.removeLayer(landuseLayer);
                }
                
                if (data.features) {
                    log(`Adding ${data.features.length} land-use polygons`);
                    landuseLayer = L.geoJSON(data, {
                        style: function(feature) {
                            return {
                                fillColor: feature.properties.color || '#00ff00',
                                weight: 1,
                                opacity: 0.8,
                                color: '#ffffff',
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            layer.bindPopup(`
                                <strong>${feature.properties.landuse_type}</strong><br>
                                District: ${feature.properties.district}<br>
                                Area: ${feature.properties.area_km2} km²
                            `);
                        }
                    }).addTo(map);
                    
                    log('Land-use data added successfully');
                } else {
                    log('No features in land-use data');
                }
                
            } catch (error) {
                log(`Error loading land-use data: ${error.message}`);
            }
        }
        
        // Test API
        async function testAPI() {
            log('Testing API endpoints...');
            
            try {
                // Test districts API
                const districtResponse = await fetch('/api/districts/telangana');
                const districtData = await districtResponse.json();
                log(`Districts API: ${districtResponse.status} - ${districtData.districts ? districtData.districts.length + ' districts' : 'No districts'}`);
                
                // Test boundaries API
                const boundaryResponse = await fetch('/api/boundaries/telangana');
                const boundaryData = await boundaryResponse.json();
                log(`Boundaries API: ${boundaryResponse.status} - ${boundaryData.districts ? boundaryData.districts.features.length + ' features' : 'No boundaries'}`);
                
                // Test land-use API
                const landuseResponse = await fetch('/api/landuse_data/telangana');
                const landuseData = await landuseResponse.json();
                log(`Land-use API: ${landuseResponse.status} - ${landuseData.features ? landuseData.features.length + ' features' : 'No land-use data'}`);
                
            } catch (error) {
                log(`API test error: ${error.message}`);
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM loaded, starting initialization...');
            
            initMap();
            loadDistricts('telangana');
            
            document.getElementById('stateSelect').addEventListener('change', function(e) {
                currentState = e.target.value;
                log(`State changed to: ${currentState}`);
                loadDistricts(currentState);
            });
            
            document.getElementById('loadBoundaries').addEventListener('click', function() {
                loadBoundaries(currentState);
            });
            
            document.getElementById('loadLanduse').addEventListener('click', function() {
                loadLanduse(currentState);
            });
            
            document.getElementById('testAPI').addEventListener('click', testAPI);
        });
    </script>
</body>
</html>
